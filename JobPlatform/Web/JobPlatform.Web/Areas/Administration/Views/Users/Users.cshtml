@model JobPlatform.Web.ViewModels.Administration.Dashboard.Users.UsersViewModel
@{
    this.ViewData["Title"] = "User Panel";
}

<form id="userForm" method="post"></form>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">@this.ViewData["Title"]</h6>
    </div>
    <div class="card-body" >
        <div class="table-responsive">
            <table class="table table-bordered" id="userTable" width="98%" cellspacing="0">
                 <thead>
                     <tr>
                         <th>User Name</th>
                         <th>Full Name</th>
                         @foreach (var role in Model.Roles)
                         {
                             <th>@role.Name</th>
                         }
                     </tr>
                 </thead>
                 <tbody>
                     @foreach (var user in this.Model.Users)
                     {
                         <tr id="@user.Id">
                             <td>
                                 <a asp-controller="Users" asp-action="UserById" asp-route-id="@user.Id">@user.UserName</a>
                             </td>
                             <td>@user.FullName</td>
                             @foreach (var roleId in Model.Roles)
                             {
                                 @if (user.RolesName.FirstOrDefault(x => x
                               == roleId.Name) != null)
                                 {
                                     <td>
                                         <a href="#" style="color: green" onclick="changeRole('@user.Id', '@roleId.Id', false),reresh()">
                                             <div>
                                                 <i class="fa fa-check"></i>
                                             </div>
                                         </a>
                                     </td>
                                 }
                                 else
                                 {
                                     <td>
                                         <a href="#" style="color: red" onclick="changeRole('@user.Id', '@roleId.Id', true),reresh()">
                                             <div>
                                                 <i class="fa fa-times"></i>
                                             </div>
                                         </a>
                                     </td>
                                 }
                             }

                         </tr>
                     }
                 </tbody>
              </table>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript" charset="utf8" src="~/js/jquery.dataTables.js"></script>
    <script>

        function changeRole(userId, roleId, onOff) {
            var token = $("#userForm input[name=__RequestVerificationToken]").val();
            var json = { userId: userId, roleId: roleId, onOff: onOff };

            $.ajax({
                url: "/api/role",
                type: "POST",
                data: JSON.stringify(json),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                headers: { 'X-CSRF-TOKEN': token },
                success: $.ready.then.call(reresh())

            });

            function reresh() {
                setTimeout(function () {// wait for 5 secs(2)
                    location.reload(); // then reload the page.(3)
                }, 1000);
            }
        }

        $(document).ready(function () {
            $('#userTable').DataTable();
        });
    </script>
}
